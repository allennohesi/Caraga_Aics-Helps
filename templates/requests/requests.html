{% extends 'layout.html' %}
{% block content %}
<div class="container-fluid">
    <div class="page-title">
        <div class="row">
            <div class="col-6">
                <h3>New Requests</h3>
            </div>
            <div class="col-6">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{% url 'home' %}">Home</a>
                    </li>
                    <li class="breadcrumb-item active">New Requests</li>
                </ol>
            </div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-pills" id="pills-tab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" id="pill-information" data-bs-toggle="pill" href="#information" role="tab">
                                <i class="fa fa-file-text-o"></i> Information
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" id="pill-assessment" data-bs-toggle="pill" href="#assessment" role="tab">
                                <i class="fa fa-question"></i> Assessment
                            </a>
                        </li>
                    </ul>
                    <form id="submitNewRequestForm">
                    {% csrf_token %}
                    <div class="tab-content" id="pills-icontabContent">
                        <div class="tab-pane fade show active m-t-30" id="information" role="tabpanel">
                            <small>Client Identifying Information</small>
                            <br><br>
                            <input type="text" name="client_id" id="client_id" hidden> 
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Client Name <span class="txt-danger">*</span></label>
                                        <select class="form-control select client_beneficiary" id="client_beneficiary" name="client" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Birthdate</label>
                                        <input type="date" class="form-control f-w-900 upper" id="birthdate" readonly>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label>Age</label>
                                        <input type="text" class="form-control f-w-900 upper" id="age" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Sex</label>
                                        <input type="text" class="form-control f-w-900 upper" id="sex" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <label>Relationship to Beneficiary <span class="txt-danger">*</span></label>
                                        <select class="form-control select" id="relationship" name="relationship" required>
                                            <option></option>
                                            {% for row in relation %}
                                            <option value="{{ row.id }}">{{ row.name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Contact Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="contact_number" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Civil Status</label>
                                        <input type="text" class="form-control f-w-900 upper" id="civil_status" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Region</label>
                                        <input type="text" class="form-control f-w-900 upper" id="region" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Province</label>
                                        <input type="text" class="form-control f-w-900 upper" id="province" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" class="form-control f-w-900 upper" id="city" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Barangay</label>
                                        <input type="text" class="form-control f-w-900 upper" id="barangay" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>House / Block / Lot No.</label>
                                        <input type="text" class="form-control f-w-900 upper" id="house_no" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Street</label>
                                        <input type="text" class="form-control f-w-900 upper" id="street" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Subdivision / Village</label>
                                        <input type="text" class="form-control f-w-900 upper" id="village" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>ID Presented</label>
                                        <input type="text" class="form-control f-w-900 upper" id="id_presented" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>ID Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="id_presentedNo" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>4Ps Member</label>
                                        <input type="text" class="form-control f-w-900 upper" id="is_4psmember" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>4Ps ID Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="4ps_id_number" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Indigenous People</label>
                                        <input type="text" class="form-control f-w-900 upper" id="indi" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Tribe</label>
                                        <input type="text" class="form-control f-w-900 upper" id="tribe" readonly>
                                    </div>
                                </div>
                                <br><br>
                                <div class="card" id="display_transaction">
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <br>
                                            <label>Client's Transaction History</label>
                                            <br>
                                            <div class="table table-responsive">
                                                <table class="table table-bordered table-hover" id="transaction-table">
                                                    <thead>
                                                        <th>Tracking Number</th>
                                                        <th class="text-center">Type of Assistance</th>
                                                        <th class="text-center">Assistance Category</th>
                                                        <th class="text-center">Social Worker</th>
                                                        <th class="text-center">Date of Transaction Assessment</th>
                                                        <th class="text-center">Status</th>
                                                    </thead>
                                                    <tbody>
                                                        <td colspan="7" class="text-center">No data available.</td>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <small>Beneficiary Identifying Information</small>
                            <div class="form-group float-end">
                                <input type="checkbox" class="form-check-input" id="same_with_client"> Same with Client
                            </div>
                            <br><br>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Beneficiary Name <span class="txt-danger">*</span></label>
                                        <select class="form-control select client_beneficiary" id="beneficiary" name="beneficiary" required></select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Birthdate</label>
                                        <input type="date" class="form-control f-w-900 upper" id="bene_birthdate" readonly>
                                    </div>
                                </div>
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <label>Age</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_age" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Sex</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_sex" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Contact Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_contact_number" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Civil Status</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_civil_status" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Indigenous People</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_indi" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Tribe</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_tribe" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Region</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_region" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Province</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_province" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>City</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_city" readonly>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Barangay</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_barangay" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>House / Block / Lot No.</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_house_no" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Street</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_street" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Subdivision / Village</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_village" readonly>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>ID Presented</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_IDPresented" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>ID Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_IDNo" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>4Ps Member</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_is_4psmember" readonly>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>4Ps ID Number</label>
                                        <input type="text" class="form-control f-w-900 upper" id="bene_4ps_id_number" readonly>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <small>Beneficiary Family Composistion</small>
                            <br><br>
                            <div class="row mb-3">
                                <div class="table table-responsive">
                                    <table class="table table-bordered table-hover" id="family-composition-table">
                                        <thead>
                                            <th>Full Name</th>
                                            <th class="text-center">Sex</th>
                                            <th class="text-center">Birthdate</th>
                                            <th class="text-center">Relation</th>
                                            <th class="text-center">Age</th>
                                            <th class="text-center">Occupation</th>
                                            <th class="text-end">Salary per month</th>
                                        </thead>
                                        <tbody>
                                            <td colspan="7" class="text-center">No data available.</td>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="row">
                                <div class="form-group">
                                    <a class="btn btn-primary btn-lg" id="next">Next</a>
                                </div>
                            </div>
                            <br><br>
                        </div>
                        <div class="tab-pane fade m-t-30" id="assessment" role="tabpanel">
                            <div class="row mb-3">
                                <div class="col-md-1">
                                    <div class="form-group">
                                        <b><label>Queue Number <span class="txt-danger">*</span></label></b>
                                        <input type="text" class="form-control f-w-900 upper" id="queu_number" name="queu_number" required>
                                    </div>
                                </div>
                            </div>
                            <br>
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <b>
                                    <label>On-site / Off-site <span class="txt-danger">*</span></label><br>
                                    <input type="text" id="new" name="status" hidden>
                                    &nbsp; &nbsp; &nbsp;<input type="radio" value="1" id="new_client" required> New &nbsp; &nbsp; &nbsp;<input type="radio" id="returning_client" value="2" required> Returning
                                    &nbsp; &nbsp; &nbsp;<input type="radio" name="site" value="1" required checked> On-Site
                                    &nbsp; <input class="form-check-input" id="walkin" name="walkin" value="1" type="checkbox" checked> WALK-IN
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="referral" name="referral" value="1" type="checkbox"> REFERRAL
                                    <input type="radio" name="site" value="2" disabled> Off-Site
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="checkbox" name="online" value="1" type="checkbox" disabled> ONLINE
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <div class="form-group">
                                        <label>Priority <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="priority_name" required>
                                            <option></option>
                                            {% for row in PriorityLine %}
                                            <option value="{{ row.id }}">{{ row.priority_name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <label>Case Study <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="case_study" required>
                                            <option></option>
                                            <option value="1">No</option>
                                            <option value="2">Yes</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <div class="form-group">
                                        <label>Client's Category <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="clients_category" required>
                                            <option></option>
                                            {% for row in category %}
                                            <option value="{{ row.id }}">{{ row.name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <label>Sub-Category <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="clients_subcategory" required>
                                            <option></option>
                                            {% for row in sub_category %}
                                            <option value="{{ row.id }}">{{ row.name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <div class="form-group">
                                        <label>Beneficiary's Category <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="bene_category" required>
                                            <option></option>
                                            {% for row in category %}
                                            <option value="{{ row.id }}">{{ row.name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-5">
                                    <div class="form-group">
                                        <label>Sub-Category <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="bene_subcategory" required>
                                            <option></option>
                                            {% for row in sub_category %}
                                            <option value="{{ row.id }}">{{ row.name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="form-group">
                                    <label>Purpose <span class="txt-danger">*</span></label>
                                    <textarea class="form-control f-w-900" rows="10" name="problem" required></textarea>
                                </div>
                            </div>
                            <small>Recommended Services and Assistance</small>
                            <hr>
                            <div class="row mb-3">
                                <div class="col-md-7">
                                    <b>
                                    &nbsp; <input class="form-check-input" id="gl" name="guarantee_letter" value="1" type="checkbox"> Guarantee Letter
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="cv" name="cash_voucher" value="1" type="checkbox"> Cash Voucher
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="pcv" name="petty_cash" value="1" type="checkbox"> Petty Cash Voucher
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="" name="ce_cash" value="1" type="checkbox"> CE Cash
                                    &nbsp; &nbsp; &nbsp;<input class="form-check-input" id="" name="ce_gl" value="1" type="checkbox"> CE Guaratantee Letter
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Assistance Type <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="assistance_type" id="assistance_type" required>
                                            <option value="">Choose</option>
                                            {% for row in assistance_type %}
                                            <option value="{{ row.id }}">{{ row.type_name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Assistance Category <span class="txt-danger">*</span></label>
                                        <select class="form-control select" name="assistance_category" id="assistance_category" required>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Date Entried <span class="txt-danger">*</span></label>
                                        <input type="datetime-local" class="form-control f-w-900 upper" name="date_entried" required>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-dark" role="alert">
                                Don't forget to assign a Social Worker
                            </div>
                            <small>Active Social Worker</small>
                            <hr>
                            <div class="row mb-3">
                                <div class="table table-responsive">
                                    <table class="table table-bordered table-hover" id="">
                                        <thead>
                                            <th>ASSIGNED</th>
                                            <th class="text-center">PENDING ASSESSMENT</th>
                                            <th class="text-center">ONGOING ASSESSMENT</th>
                                            <th class="text-center">COMPLETE ASSESSMENT</th>
                                            <th class="text-center">FOR CASE STUDY</th>
                                            <th class="text-center">ACTIVE</th>
                                        </thead>
                                        {% for row in active_swo %}
                                        <tbody>
                                            
                                            <td><input type="radio" name="user" value="{{row.user.id}}"> {{row.user.get_fullname|upper}}</td>
                                            <td class="text-center">{{row.get_total}}</td>
                                            <td class="text-center">{{row.get_ongoing}}</td>
                                            <td class="text-center">{{row.get_complete}}</td>
                                            <td class="text-center">{{row.case_study}}</td>
                                            <td class="text-center"><i class="fa fa-check-circle txt-success"></i></td>
                                            
                                        </tbody>
                                        {% endfor %}
                                    </table>
                                </div>
                            </div>
                            <br><br>
                            <div class="row">
                                <div class="form-group">
                                    <a class="btn btn-primary btn-lg" id="previous">Previous</a>
                                    {% if active_swo %}
                                    <button type="submit" class="btn btn-primary btn-lg">Finished</button>
                                    {% endif %}
                                </div>
                            </div>
                            <br><br>
                        </div>
                    </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block script %}
<script>
    $("#sub_type_of_assistance").on("change", function(e) {
        var reg_price = $("#sub_type_of_assistance").val()
    });

    $('#display_transaction').hide();
    $(document).ready(function(){
        $('.select').select2({
            width: '100%',
            placeholder: 'CHOOSE',
            containerCssClass: 'select'
        });

        $('#next').on('click', function(){
            if ($('#relationship').val() != ""){
                new bootstrap.Tab(document.querySelector('#pills-tab a[href="#assessment"]')).show();
            } else {
                Swal.fire("Oops...", "Please choose a relationship before proceeding to the next page.", "warning");
            }
        });
        $('#previous').on('click', function(){
            new bootstrap.Tab(document.querySelector('#pills-tab a[href="#information"]')).show();
        });

        birthdate.max = new Date().toISOString().split("T")[0];
        $('.client_beneficiary').select2({
            width: '100%',
            placeholder: 'CHOOSE',
            containerCssClass: 'select',
            allowClear: true,
            ajax: {
                url: "{% url 'get_all_client_beneficiary' %}",
                method: "GET",
                dataType: "json",  // Corrected the property name to "dataType"
                data: function(params) {
                    return {
                        searchTerm: params.term
                    };
                },
                processResults: function(response) {
                    $('#relationship').val("").trigger('change');
                    $('#same_with_client').prop('checked', false);
                    return {
                        results: response
                    };
                },
                cache: true
            }
        });
        var select2options = {
            width: "100%",
            containerCssClass: 'select',
            placeholder: 'Choose',
        }

        new Select2Cascade($('#assistance_type'), $('#assistance_category'), '/requests/category/get/:parentId:', select2options);

        new Select2Cascade($('#assistance_category'), $('#sub_type_of_assistance'), '/requests/sub_category/get/:parentId:', select2options);

        $('#client_beneficiary').on('change', function(){
            var id = $(this).val();
               $.ajax({
                    url: '/requests/get-client-information/' + id,
                    type: 'GET',
                    success: function(response){
                        $('#new').val(response.new);
                        if((response.new) == 1){
                            $('#new_client').prop('checked', true);
                            $('#returning_client').prop('checked', false);
                        }else{
                            $('#new_client').prop('checked', false);
                            $('#returning_client').prop('checked', true);
                        }
                        $('#birthdate').val(response.birthdate);
                        $('#age').val(response.age);
                        $('#sex').val(response.sex);
                        $('#contact_number').val(response.contact_number);
                        $('#civil_status').val(response.civil_status);
                        $('#region').val(response.region);
                        $('#province').val(response.province);
                        $('#city').val(response.city);
                        $('#barangay').val(response.barangay);
                        $('#house_no').val(response.house_no);
                        $('#village').val(response.village);
                        $('#street').val(response.street);
                        $('#is_4psmember').val(response.is_4ps);
                        $('#4ps_id_number').val(response.id_number_4ps);
                        $('#indi').val(response.is_indi);
                        $('#tribe').val(response.tribe);
                        $('#client_id').val(response.client_id);
                        $('#id_presented').val(response.id_presented);
                        $('#id_presentedNo').val(response.id_presentedNo);

                        var transaction_history = response.transaction_history
                        var template = "";
                        for(var i=0; i < transaction_history.length; i++) {
                            template += `
                                <tr class="table-primary">
                                    <td class="f-w-900 upper">`+ transaction_history[i]['tracking_number'] +`</td>
                                    <td class="text-center f-w-900 upper">`+ transaction_history[i]['type_of_assitance'] +`</td>
                                    <td class="text-center f-w-900 upper">`+ transaction_history[i]['assistance_category'] +`</td>
                                    <td class="text-center f-w-900 upper">`+ transaction_history[i]['social_worker'] +`</td>
                                    <td class="text-center f-w-900 upper">`+ transaction_history[i]['date_assessment'] +`</td>
                                    <td class="text-center f-w-900 upper">`+ transaction_history[i]['status'] +`</td>
                                </tr>
                            `
                        }
                        if(template){
                            $('#display_transaction').show();
                            $('#transaction-table tbody').html(template)
                        }else{
                            $('#transaction-table tbody').html(template)
                            $('#display_transaction').hide();
                        }
                        
                    }
               });
        });
        $('#same_with_client').on('change', function(){
            if($("#same_with_client").is(':checked')){
                if($('#client_beneficiary').val() != null) {
                    var $option = $("<option selected></option>").val($('#client_beneficiary').val()).text($('#client_beneficiary').select2('data')[0].text);
                    $('#beneficiary').append($option).trigger('change');
                    getBeneficiary($('#client_beneficiary').val());
                    
                    relation = $('#relationship').find("option:contains('SELF')").val();
                    $('#relationship').val(relation).trigger('change');
                }
            } else {
                $('#beneficiary').val('').trigger('change');
                $('#bene_birthdate').val("");
                $('#bene_age').val("");
                $('#bene_sex').val("");
                $('#bene_contact_number').val("");
                $('#bene_civil_status').val("");
                $('#bene_province').val("");
                $('#bene_city').val("");
                $('#bene_barangay').val("");
                $('#bene_house_no').val("");
                $('#bene_village').val("");
                $('#bene_street').val("");
                $('#bene_region').val("");
                $('#bene_is_4psmember').val("");
                $('#bene_4ps_id_number').val("");
                $('#bene_indi').val("");
                $('#bene_tribe').val("");
                $('#relationship').val("").trigger('change');
                $('#user').val("")
                $('#priority_name').val("")
                $('#case_study').val("")
                $('#bene_IDPresented').val("");
                $('#bene_IDNo').val("");
                $('#family-composition-table tbody tr').remove();
            }
        });
        $('[name="cash_voucher"]').change(function()
        {
          if ($(this).is(':checked')) {
            $('#pcv').prop('checked', true);
          }else{
            $('#pcv').prop('checked', false);
          };
        });
        if(!$("#same_with_client").is(':checked')){
            $('#beneficiary').on('change', function(){
                getBeneficiary($(this).val());
            });
        }
        function getBeneficiary(id){
            $.ajax({
                url: '/requests/get-beneficiary-information/' + id,
                type: 'GET',
                success: function(response){
                    $('#bene_birthdate').val(response.birthdate);
                    $('#bene_age').val(response.age);
                    $('#bene_sex').val(response.sex);
                    $('#bene_contact_number').val(response.contact_number);
                    $('#bene_civil_status').val(response.civil_status);
                    $('#bene_region').val(response.region);
                    $('#bene_province').val(response.province);
                    $('#bene_city').val(response.city);
                    $('#bene_barangay').val(response.barangay);
                    $('#bene_house_no').val(response.house_no);
                    $('#bene_village').val(response.village);
                    $('#bene_street').val(response.street);
                    $('#bene_is_4psmember').val(response.is_4ps);
                    $('#bene_4ps_id_number').val(response.id_number_4ps);
                    $('#bene_indi').val(response.is_indi);
                    $('#bene_tribe').val(response.tribe);
                    $('#bene_IDPresented').val(response.id_presented);
                    $('#bene_IDNo').val(response.id_presentedNo);

                    var family_composistion = response.family_composistion

                    var template = "";
                    for(var i=0; i < family_composistion.length; i++) {
                        template += `
                            <tr>
                            <td class="f-w-900 upper">`+ family_composistion[i]['fullname'] +`</td>
                            <td class="text-center f-w-900 upper">`+ family_composistion[i]['sex'] +`</td>
                            <td class="text-center f-w-900 upper">`+ family_composistion[i]['birthdate'] +`</td>
                            <td class="text-center f-w-900 upper">`+ family_composistion[i]['relation'] +`</td>
                            <td class="text-center f-w-900 upper">`+ family_composistion[i]['age'] +`</td>
                            <td class="text-center f-w-900 upper">`+ family_composistion[i]['occupation'] +`</td>
                            <td class="text-end f-w-900 upper">`+ family_composistion[i]['salary'] +`</td>
                            </tr>
                        `
                    }

                    $('#family-composition-table tbody').html(template)
                }
           });
        }

        function validationForm(){
            var invalid = false;
            $('.form-control').each(function() {
                if (/<[a-z][\s\S]*>/i.test($(this).val())) {
                    $(this).addClass('is-invalid');
                    $(this).next('.invalid-feedback').html("The field cannot contain HTML tags.")
                    invalid = true;
                }
            });
            return invalid;
        }
        $('.user').select2({
            width: '100%',
            placeholder: 'Choose',
            containerCssClass: 'select',
            allowClear: true,
            ajax: {
                url: "{% url 'get_all_user' %}",
                method: "GET",
                datatype: "json",
                data: function(params) {
                    return {
                        searchTerm: params.term
                    }
                },
                processResults: function(response) {
                    return {
                        results:response
                    };
                },
                cache: true
            }
        });
        $('#submitNewRequestForm').on('submit', function(e){
            e.preventDefault();
            var form = new FormData(this);
            if (!validationForm()){
                Swal.fire({
                    title: "Are you sure",
                    text: "You want to file this new transaction?",
                    icon: "info",
                    showCancelButton: true,
                    confirmButtonText: "Yes",
                    allowOutsideClick: false,
                    showLoaderOnConfirm: true,
                    preConfirm: function (){
                        return $.post({
                            url: "{% url 'new_requests' %}",
                            data: form,
                            success : function (response){
                                if(!response.error){
                                    Swal.fire({
                                        title: response.tracking_number,
                                        html:  response.msg,
                                        icon: "success",
                                        allowOutsideClick: false,
                                    }).then((result) => {
                                        if (result.isConfirmed){
                                            location.reload();
                                            $('.select').val('').trigger('change');
                                            $('#submitNewRequestForm').trigger('reset');
                                            new bootstrap.Tab(document.querySelector('#pills-tab a[href="#information"]')).show();
                                            $('#family-composition-table tbody tr').remove();
                                            $('#transaction-table tbody tr').remove();
                                        }
                                    });
                                } else {
                                    Swal.fire("Oops...", response.msg, "warning");
                                }
                            },
                            cache       : false,
                            contentType : false,
                            processData : false,
                        });
                    },
                });
            }
        });
    });
</script>

{% endblock %}